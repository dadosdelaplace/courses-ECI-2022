```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Sacando datos de las piedras {#importar-exportar}

:::: {.blackbox data-latex=""}

Scripts usados:

* [**script13.R**](https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script13.R): importar/exportar datos.  Ver en <https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script13.R>
::::

Hemos aprendido a **crear nuestros propios datos** pero muchas veces los cargaremos de distintos archivos, fuentes, etc. Vamos a ver algunas <mark>**formas que tenemos para importar (cargar) datos**<mark>.

## Importación de datos


## Archivo .RData

La forma más sencilla de guardar datos y variables en `R`, y que además ocupa menos espacio en nuestro disco duro, es guardarlo en archivos propios que tiene `R` como son los <mark>**archivos con extensiones `.rda` y `.RData`**</mark>.

Es **recomendable** tener los datos en la <mark>**misma carpeta del proyecto**</mark> pero una carpeta separada, ya que podemos tener muchos archivos y así no mezclamos dichos ficheros con los códigos que escirbamos. En la carpeta `DATOS` del proyecto tenemos 1 archivo `.RData`: `titanic.RData`, un conjunto de datos obtenidos de la plataforma de aprendizaje y predicción <https://www.kaggle.com/c/titanic/overview>, con los datos de los pasajeros del Titanic (nombre, título, cabina, si sobrevivió o no, edad, etc)

<mark>**¿Cómo cargar archivos `.RData`?**</mark>

Muy sencillo: como son ficheros nativos de `R`, basta con usar la función de carga `load()`, y dentro la ruta del archivo que queramos cargar

```{r}
# Al fijar directorio de trabajo, no necesitamos toda la ruta, solo "./" y la ruta dentro de la carpeta del proyecto
load("./DATOS/titanic.RData")
```


En el panel de **entorno de la parte superior derecha** ahora tendremos un `data.frame` que antes no teníamos. Ya hemos visto que una función muy útil es `head()`, con argumento el nombre de un `data.frame`, que nos permite visualizar las primeras columnas.

```{r}
head(titanic)
```


### Archivo .csv o .txt

Otra opción habitual son los <mark>**archivos `.csv` (comma separated values)**</mark>: son archivos **separados por comas** (u otro caracter como puntos, puntos y comas, o tabuladores). En apariencia cuando los abrimos en el ordenador son como un Excel (ya que los abre el Excel), pero ocupan mucho menos que un Excel y su **lectura es universal** (independiente de tener instalado o no el Excel) ya que son archivos de texto **sin formato**.

Para leer un archivo `.csv` basta con usar la función `read.csv()`e indicarle la ruta del archivo para su lectura (argumento `file`, aunque tiene otros argumentos extras por si queremos especifiar el caracter que separa las columnas, si incluímos o no una cabecera de la tabla, y otros argumentos que puedes consultar con `? read.csv`).


```{r}
titanic <- read.csv(file = "./DATOS/titanic.csv")
```

Ya tenemos nuestro archivo `.csv` cargado y además en formato `data.frame`.

Una de las ventajas de la carga de estos archivos en `R` es que podemos hacerlo sin <mark>**ni siquiera tener el archivo en nuestro ordenador**</mark>, a través de un enlace web. Vamos a ver un ejemplo con los datos del ISCIII sobre la pandemia. En su web <https://cnecovid.isciii.es/covid19/#documentaci%C3%B3n-y-datos> tienen varios archivos colgados, que podemos o bien descargarlos, o haciendo click derecho <mark>**«Copiar dirección de enlace»**</mark> obtenemos un enlace. Por ejemplo, para el archivo `casos_tecnica_ccaa.csv`, que nos almacena el número de casos por técnica diagnóstica y CCAA, tenemos el enlace <https://cnecovid.isciii.es/covid19/resources/casos_tecnica_ccaa.csv>. Dicho enlace es el que se abre cuando pulsamos en Descargar, pero podemos introducirlo directamente en `R`, sustituyendo a nuestra ruta.

```{r}
datos_ISCIII <- read.csv(file = "https://cnecovid.isciii.es/covid19/resources/casos_tecnica_ccaa.csv")
dim(datos_ISCIII)
head(datos_ISCIII)
```

El archivo tiene **8 columnas**: un código identificador de las CCAA, la fecha, y 6 variables relativas a casos detectados (en función de la técnica con la que se ha detectado). Y además tiene un **número de filas** igual a las 19 CCAA (17 + Ceuta + Melilla) por el número de días en los que hay registros.

<mark>**¿Cuál es la ventaja de cargarlo así?**</mark> Ese enlace es fijo, y tendrá siempre el último archivo, actualizado, sin preocuparnos de tener que bajarnos cada día el archivo: simplemente ejecutamos dicha carga, y tenemos asegurado que nos bajaremos el archivo más actualizado posible.


Vamos a ver otro ejemplo con el repositorio de Github de la experta en lingüística computacional [Elena Álvarez Mellado](https://lirondos.github.io/). En su [repositorio](https://github.com/lirondos) tiene guardados los [discursos navideños](https://github.com/lirondos/discursos-de-navidad/tree/master/data/speeches) de los jefes de Estado (los democráticos y los no democráticos, desde Franco hasta Felipe VI), desde 1937 hasta 2021.



```{r discursos, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Discursos guardados en el repositorio de <https://github.com/lirondos/discursos-de-navidad>."}
knitr::include_graphics("./img/foto_discursos.jpg")
```

Cada discurso está guardado en un <mark>**archivo `.txt`**</mark>, un archivo que no tiene una estructura tabular (con filas y columnas, separadas por caracteres) como los archivos `.csv`. Para este tipo de archivos podemos usar `read.delim`.

```{r warning = FALSE}
discurso_1937 <-
  read.delim(file = "https://raw.githubusercontent.com/lirondos/discursos-de-navidad/master/data/speeches/1937.txt")
discurso_1937
```

Ya veremos como analizar textos y palabras, o de como hacer un bucle para bajarnos todos.


### Archivo .xlsx

Muchas veces no tendremos un `.csv` (por desgracia) y nos tocará <mark>**leer desde un excel**</mark>. Para ello deberemos instalar (la primera vez) y cargar el paquete `{readxl}` que nos permitirá usar funciones para cargar archivos `.xls` (la función `read_xls()`) y archivos `.xlsx` (la función `read_xlsx()`). Además del argumento `path` con la ruta del archivo, podemos en el argumento `sheet` indicarle la hoja de Excel a leer (en caso de tener varias).

Vamos a leer por ejemplo el archivo `Boston.xlsx`, que contienen información del valor inmobiliario de 506 distritos de Boston. Puedes ver la información de las variables con `? MASS::Boston`.

```{r Boston-xlsx, eval = FALSE}
install.packages("readxl")
library(readxl)
boston <- read_xlsx(path = "./DATOS/Boston.xlsx")
```

```{r Boston-xlsx-2, include = FALSE}
library(readxl)
boston <- read_xlsx(path = "./DATOS/Boston.xlsx")
```

```{r head-boston}
head(boston)
```



### Desde paquete

Por último, una opción muy común es <mark>**cargar datos desde paquetes que ya los tienen**</mark> (o los consiguen a través de una API). Un ejemplo de ello es el paquete `{MASS}`, del que ya hemos hablado, que contiene una gran cantidad de conjuntos de datos para usarlos en nuestro propio aprendizaje, como es el conjunto `MASS::Boston`.

Veamos otro ejemplo con uno de los paquetes más útiles para conseguir datos, el <mark>**paquete del EUROSTAT**</mark> `{eurostat}`. Con la función `search_eurostat()` nos permite buscar datasets por palabras clave (nos muestra una tabla con los datasets y sus códigos) y con `get_eurostat()` podemos acceder a ellos proporcionando el código del archivo.


```{r eurostat}
library(eurostat) # instalar la primera vez

# Buscamos datos por palabras clave
search_eurostat("education")

# Accedemos a un dato concreto por codigo
get_eurostat("hlth_ehis_de3")
``` 

### Otras fuentes

En el futuro veremos algunas formas muy interesantes de obtener datos directamente desde `R`. He aquí algunas opciones:

* Datos de **Twitter** (conectándonos a su API).
* Datos de **Spotify** (conectándonos a su API).
* Datos de **programas electorales** directamente desde los PDF que publican los partidos políticos.
* Datos de **encuestas electorales** directamente desde wikipedia.
* Datos del [**INE**](https://ropenspain.es/paquetes/).
* Datos del [**BOE**](https://ropenspain.es/paquetes/).
* Datos del [**catastro**](https://ropenspain.es/paquetes/).
* Datos del [**AEMET**](https://ropenspain.es/paquetes/).
* Datos electorales del [**Ministerio del Interior**](https://ropenspain.es/paquetes/).
* Datos de [**partidas de ajedrez**](https://github.com/JaseZiv/chessR)

Pero vayamos poco a poco :)

## Exportación de datos

Aunque se puede exportar en cualquier formato que puedas importar, vamos a ver las <mark>**dos formas más útiles y eficientes de exportar datos en `R`**</mark>: 

- fichero `.RData`.
- fichero `.csv` (obviaremos la exportación a Excel porque un `.csv` ya es posible abrirlo con dicho engendro del demonio).


La exportación en fichero `.RData` es la opción **más recomendable si tú o tu equipo solo trabajáis con `R`**, es la opción nativa de fichero, para que su importación sea tan sencilla como una función `load()`. Para exportar en `R.Data` basta con uses la función `save()`, indícandole lo que quieres guardar y la ruta donde quieres guardarlo.

Es **importante** entender que la principal ventaja de exportar un fichero `.RData` es que no se está portando una tabla, o un fichero tabulado con un formato de filas y columnas: estás exportando **cualquier cosa**, cualquier variable de `R`, con la naturaleza de esa variable intacta, sin necesidad de pasarlo otro formato.

```{r exportando, eval = FALSE}
nombres <- c("javier", "carla")
# Exportamos en .RData la variable nombres 
save(nombres, file = "./EXPORTAR/nombres.RData")
``` 

Para tenerlo organizado, la orden anterior está hecha habiendo creado en nuestra carpeta del proyecto una carpeta `EXPORTAR` para guardar lo que vayamos exportando. Ese fichero solo podrá ser abierto por `R`, pero cuando lo cargemos, tendremos la variable `nombres` tal cual la hemos guardado.

&nbsp;

No siempre trabajamos en `R` y a veces necesitamos una exportación de  un `data.frame` o una tabla que podamos abrir en nuestra ordenador, ya sea para explicársela a alguien o para enviársela a otra persona. Para ello exportaremos en `.csv`, un fichero sin formato, y que es capaz de ser abierto por todo tipo de hojas de cálculo: basta que usemos la función `write.csv()`.

```{r eval = FALSE}
# Exportamos en .csv el data.frame del ISCIII
write.csv(datos_ISCIII, file = "./EXPORTAR/datos_ISCIII.csv")
```

&nbsp;


**`r colorize("WARNING: líneas de código en los errores", "#ffc107")`**
  
Dado que los errores del código nos vendrán referenciados en la consola por el número de línea donde fueron detectados, puede sernos muy útil mostrar dichos números en la barra lateral izquierda, yendo a `Tools << Global Options << Code << Display << Show line numbers`

```{r show-line-numbers, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Líneas de código."}
knitr::include_graphics("./img/show_line_numbers.jpg")
```

## Consejos


**`r colorize("CONSEJOS", "#20935E")`**

&nbsp;

**`r colorize("Paquete rvest", "#4197D2")`**

En dicho paquete tienes más <mark>**funciones para una lectura directamente como si navegaras por una página web**</mark>. Ver <https://github.com/tidyverse/rvest>.

```{r}
# Ejemplo cargando datos de una tabla de wikipedia: 
# encuestas elecciones alemanas 2021
library(rvest)
library(tidyverse)
wiki <- paste0("https://es.wikipedia.org/wiki/",
              "Elecciones_federales_de_Alemania_de_2021")
html<- read_html(wiki)
datos <- html_nodes(html,".wikitable")

# Tabla (tibble) (e ignoramos filas con algún valores ausentes)
resultados_encuestas <-
  html_table(datos[[5]], header = TRUE) %>% drop_na()

# Resumen de columnas: casa encuestadora, fecha, muestra, partidos
glimpse(resultados_encuestas)
```

&nbsp;

**`r colorize("Margen derecho en la ventana de scripts", "#20935E")`**


Aunque no afecte a nuestro código escribir todo en una línea sin saltos de línea, no somos bárbaros/as. ¿Por qué cuadno escribes en un Word lo haces en formato vertical pero cuando programas pones todas las órdenes seguidas? Recuerda que la legibilidad de tu código no solo te ahorrará tiempo sino que te hará programar mejor. ¿Cómo podemos fijar un margen imaginario para nosotros ser quienes demos al _ENTER_? Yendo a `Tools << Global Options << Code << Display << Show margin` (es un margen imaginario para ser nosotros quienes lo hagamos efectivo, a `R` le da igual)

```{r show-margin, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Margen derecho."}
knitr::include_graphics("./img/show_margin.jpg")
```


