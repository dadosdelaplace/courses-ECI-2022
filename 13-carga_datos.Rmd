```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Sacando datos de las piedras {#importar-exportar}

Hemos aprendido a **crear nuestros propios datos** pero muchas veces los cargaremos de distintos archivos, fuentes, etc. Vamos a ver algunas <mark>**formas que tenemos para importar (cargar) datos**<mark>.

## Importación de datos


## Archivo .RData

La forma más sencilla de guardar datos y variables en `R`, y que además ocupa menos espacio en nuestro disco duro, es guardarlo en archivos propios que tiene `R` como son los <mark>**archivos con extensiones `.rda` y `.RData`**</mark>.

Es **recomendable** tener los datos en la <mark>**misma carpeta del proyecto**</mark> pero una carpeta separada, ya que podemos tener muchos archivos y así no mezclamos dichos ficheros con los códigos que escirbamos. En la carpeta `DATOS` del proyecto tenemos 1 archivo `.RData`: `titanic.RData`, un conjunto de datos obtenidos de la plataforma de aprendizaje y predicción <https://www.kaggle.com/c/titanic/overview>, con los datos de los pasajeros del Titanic (nombre, título, cabina, si sobrevivió o no, edad, etc)

<mark>**¿Cómo cargar archivos `.RData`?**</mark>

Muy sencillo: como son ficheros nativos de `R`, basta con usar la función de carga `load()`, y dentro la ruta de los archivos. 

```{r include = FALSE}
# Al fijar directorio de trabajo, no necesitamos toda la ruta, solo "./" y la ruta dentro de la carpeta del proyecto
load("./DATOS/coches.RData")
load("./DATOS/panel_vacunas_ccaa.RData")
load("./DATOS/panel_vacunas_fecha.RData")
load("./DATOS/panel_variables.RData")
```

```{r eval = FALSE}
# Al fijar directorio de trabajo, no necesitamos toda la ruta, solo "./" y la ruta dentro de la carpeta del proyecto
load("./DATOS/coches.RData") 
load("./DATOS/panel_vacunas_ccaa.RData")
load("./DATOS/panel_vacunas_fecha.RData")
load("./DATOS/panel_variables.RData")
```

```{r carga-RDATA, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Importación de ficheros de extensión .RData."}
knitr::include_graphics("./img/carga_RDATA.jpg")
```


Como ves en la imagen \@ref(fig:carga-RDATA), en el panel de entorno de la parte superior derecha ahora tendremos 4 `data.frames` que antes no teníamos. Un función muy útil es `head()`, con argumento el nombre de un `data.frame`, que nos permite visualizar las primeras columnas.

```{r}
# Ver las primeras filas de la tabla que guarda distintos modelos de coche y características
head(coches)
```


### Archivo .csv

Otra opción de importación habitual son los <mark>**archivos `.csv` (comma separated values)**</mark>: son archivos separados por comas (u otro caracter como puntos, puntos y comas, o tabuladores). En apariencia cuando los abrimos en el ordenador son como un Excel (ya que los abre el Excel), pero ocupan mucho menos que un Excel y su **lectura es universal** (independiente de tener instalado o no el Excel) ya que son archivos de texto **sin formato**.

Para leer un archivo `.csv` basta con usar la función `read_csv()` del paquete `{readr}` y la mayoría de las veces basta indicarle la ruta del archivo para su lectura (argumento `file`).


```{r paquete-readr, echo = FALSE, out.width = "95%", fig.align = "center", fig.cap = "Paquete readr."}
knitr::include_graphics("./img/readr.png")
```

```{r include = FALSE}
library(readr)
vacunas_esp <- read_csv(file = "./DATOS/datos_ES.csv")
```

```{r eval = FALSE}
install.packages("readr")
library(readr)
vacunas_esp <- read_csv(file = "./DATOS/datos_ES.csv")
```

```{r}
head(vacunas_esp)
vacunas_esp[1:5, 1:7] # Primeras filas y columnas
```

Ya tenemos nuestro archivo `.csv` cargado y además en formato `tibble`. Como hemos mentado anteriormente, las tablas en formato `tibble` son una especie particular de tablas `data.frame` con una gestión más eficiente. 



### Archivo .xlsx

Muchas veces no tendremos un `.csv` (por desgracia) y nos tocará <mark>**leer desde un excel**</mark>. Para ello deberemos instalar (la primera vez) y cargar el paquete `{readxl}` que nos permitirá usar funciones para cargar archivos `.xls` (la función `read_xls()`) y archivos `.xlsx` (la función `read_xlsx()`). Además del argumento `path` con la ruta del archivo, podemos en el argumento `sheet` indicarle la hoja de Excel a leer (en caso de tener varias).

```{r Boston-xlsx, eval = FALSE}
install.packages("readxl")
library(readxl)
boston <- read_xlsx(path = "./DATOS/Boston.xlsx")
```

```{r Boston-xlsx-2, include = FALSE}
library(readxl)
boston <- read_xlsx(path = "./DATOS/Boston.xlsx")
```

```{r head-boston}
head(boston)
```

### Desde web

Muchas veces <mark>**querremos cargar archivos colgados en la web**</mark> que, aunque al descargarlos son `.csv` o `.xlsx`, son archivos dinámicos que sabemos que van a ir cambiando, como por ejemplo los datos de casos covid, hospitalizados, ingresos UCI y fallecidos, de la página del ISCIII <https://cnecovid.isciii.es/covid19/#documentaci%C3%B3n-y-datos>.


```{r ISCIII, echo = FALSE, out.width = "75%", fig.align = "center", fig.cap = "Archivos de la pandemia en el ISCIII."}
knitr::include_graphics("./img/ISCIII.jpg")
```

Esos archivos cambian cada día, por lo que para visualizarlos, analizarlos o guardarlos cada día, tendríamos que, cada día, entrar de forma manual a la página y bajarnos el archivo. O no...

`R` nos permite **leer archivos subidos en una web, dándole a la función de lectura el enlace del archivo en lugar de la ruta local de nuestro ordenador** (para averiguar el enlace, basta con clickar botón derecho en la web y seleccionar «copiar dirección de enlace»)

```{r ISCII-2}
datos_ISCIII <- read_csv(file = "https://cnecovid.isciii.es/covid19/resources/casos_hosp_uci_def_sexo_edad_provres.csv")
head(datos_ISCIII)
```

Mientras el enlace web no cambie, cada vez que ejecutemos esa orden en nuestro código tendremos en `datos_ISCIII` el último archivo actualizado que haya, sea el que sea, sin tener que descargarlo de forma manual, ¡y sin necesidad de guardarlo en nuestro local, solo en la memoria virtual de nuestra sesión de `R`!


### Desde paquete

Por último, una opción muy común es <mark>**cargar datos desde paquetes que ya los tienen**</mark> (o los consiguen a través de API). Un ejemplo de ello es el paquete `{MASS}`, que contiene una gran cantidad de conjuntos de datos para usarlos en nuestro propio aprendizaje, como es el conjunto `MASS::Boston` con los datos de viviendas de los suburbios de la ciudad, o el paquete `{datasets}`, con conjuntos de datos tan variopintos como los pasajeros del Titanic (y si sobrevivieron o no) en `datasets::Titanic`.


```{r MASS}
head(MASS::Boston)

head(datasets::Titanic)
```

Veamos otro ejemplo con uno de los paquetes más útiles para conseguir datos, el <mark>**paquete del EUROSTAT**<mark>. 


```{r eurostat}
library(eurostat)

# Buscamos datos por palabras clave
search_eurostat("education")

# Accedemos a un dato concreto por codigo
get_eurostat("hlth_ehis_de3")
``` 

## Exportación de datos

Aunque se puede exportar en cualquier formato que puedas importar, vamos a ver las <mark>**dos formas más útiles y eficientes de exportar datos en `R`**</mark>: 

- fichero `.RData`.
- fichero `.csv` (obviaremos la exportación a Excel porque un `.csv` ya es posible abrirlo con dicho engendro del demonio).

### Guardar en .RData

La exportación en fichero `.RData` es la opción **más recomendable si tú o tu equipo solo trabajáis con `R`**, es la opción nativa de fichero, para que su importación sea tan sencilla como una función `load()`. Para exportar en `R.Data` basta con uses la función `save()`, indícandole lo que quieres guardar y la ruta donde quieres guardarlo.

Es **importante** entender que la principal ventaja de exportar un fichero `.RData` es que no se está portando una tabla, o un fichero tabulado con un formato de filas y columnas: estás exportando **cualquier cosa**, cualquier variable de `R`, con la naturaleza de esa variable intacta, sin necesidad de pasarlo otro formato.

```{r exportando, eval = FALSE}
# Exportamos en .RData la variable nombres 
save(nombres, file = "./EXPORTAR/nombres.RData")
``` 

Para tenerlo organizado, la orden anterior está hecha habiendo creado en nuestra carpeta del proyecto una carpeta `EXPORTAR` para guardar lo que vayamos exportando. Ese fichero solo podrá ser abierto por `R`, pero cuando lo cargemos, tendremos la variable `nombres` tal cual la hemos guardado.

### Guardar en .csv

No siempre trabajamos en `R` y a veces necesitamos una exportación de  un `data.frame` o una tabla que podamos abrir en nuestra ordenador, ya sea para explicársela a alguien o para enviársela a otra persona. Para ello exportaremos en `.csv`, un fichero sin formato, y que es capaz de ser abierto por todo tipo de hojas de cálculo: basta que usemos la función `write.csv()` del paquete `{readr}`.

```{r eval = FALSE}
# Exportamos en .csv el data.frame tabla
write_csv(tabla, file = "./EXPORTAR/tabla.csv")
```

&nbsp;


**`r colorize("WARNING: líneas de código en los errores", "#ffc107")`**
  
Dado que los errores del código nos vendrán referenciados en la consola por el número de línea donde fueron detectados, puede sernos muy útil mostrar dichos números en la barra lateral izquierda, yendo a `Tools << Global Options << Code << Display << Show line numbers`

```{r show-line-numbers, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Líneas de código."}
knitr::include_graphics("./img/show_line_numbers.jpg")
```

## Consejos


**`r colorize("CONSEJOS", "#20935E")`**

&nbsp;

**`r colorize("Paquete rvest", "#4197D2")`**

En dicho paquete tienes más <mark>**funciones para una lectura directamente como si navegaras por una página web**</mark>. Ver <https://github.com/tidyverse/rvest>.

```{r}
# Ejemplo cargando datos de una tabla de wikipedia: 
# encuestas elecciones alemanas 2021
library(rvest)
library(tidyverse)
wiki <- paste0("https://es.wikipedia.org/wiki/",
              "Elecciones_federales_de_Alemania_de_2021")
html<- read_html(wiki)
datos <- html_nodes(html,".wikitable")

# Tabla (tibble) (e ignoramos filas con algún valores ausentes)
resultados_encuestas <-
  html_table(datos[[5]], header = TRUE) %>% drop_na()

# Resumen de columnas: casa encuestadora, fecha, muestra, partidos
glimpse(resultados_encuestas)
```

&nbsp;

**`r colorize("Margen derecho en la ventana de scripts", "#20935E")`**


Aunque no afecte a nuestro código escribir todo en una línea sin saltos de línea, no somos bárbaros/as. ¿Por qué cuadno escribes en un Word lo haces en formato vertical pero cuando programas pones todas las órdenes seguidas? Recuerda que la legibilidad de tu código no solo te ahorrará tiempo sino que te hará programar mejor. ¿Cómo podemos fijar un margen imaginario para nosotros ser quienes demos al _ENTER_? Yendo a `Tools << Global Options << Code << Display << Show margin` (es un margen imaginario para ser nosotros quienes lo hagamos efectivo, a `R` le da igual)

```{r show-margin, echo = FALSE, out.width = "50%", fig.align = "center", fig.cap = "Margen derecho."}
knitr::include_graphics("./img/show_margin.jpg")
```


