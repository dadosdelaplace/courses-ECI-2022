```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# (PART) Estructuras de control {-}

# Estructuras condicionales if-else {#if-else}

:::: {.blackbox data-latex=""}

Scripts usados:

* [**script07.R**](https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script07.R): estructuras if-else.  Ver en <https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script07.R>

::::

Hasta ahora hemos trasteado con datos: hemos empezado desde una celda, para luego construir columnas, para luego juntarlas en algo parecido a una base de datos.

Para poder manejarnos con soltura con dichos datos es importante que conozcamos como se usan las <mark>**expresiones de control más típicas**</mark>. Una expresión de control será un **conjunto de órdenes** que nos permiten decidir por donde queremos que avance nuestro programa: ¿qué hacemos si sucede A? ¿Y si sucede B?

Si has programado en algún otro lenguaje, estarás familiarizado/a con elementos como un `if (blabla) {...} else {...}` (que los usaremos a veces) o bucles `for` y `while`. Si es la primera que programas en algún lenguaje, no te preocupes, las empezamos desde cero, empezando por las <mark>**estructuras condicionales**</mark>

* `if (condición) { código A } else { código B }`: si `condición` (por ejemplo, `x == 1`) es cierta, se ejecuta `código A`; si es falsa, se ejecuta `código B`.

## if {}
 
Una de las estructuras de control más famosas de cualquier lenguaje de programación: SI las condiciones impuestas se cumplen (`TRUE`), ejecuta las órdenes que tengamos dentro del `if {}`. Definamos por ejemplo una variable sencilla, las edades de 8 personas.

```{r}
edades <- c(14, 17, 24, 56, 31, 20, 87, 73)
```

Para comprobar cuales son menores de edades podemos aplicar lo aprendido en temas anteriores, realizando una **comparación lógica**: si es menor de edad, devuelve un `TRUE`; en caso contrario, devuelve un `FALSE`.

```{r}
edades < 18
```

Con las funciones `any()` y `all()` podemos saber si <mark>**todos o alguno de los elementos de un vector cumplen una condición**</mark>.

```{r}
all(edades >= 18) # todos mayores de edad
any(edades < 18) # existe algun menor de edad
```

Con dichos elementos vamos a construir nuestra **primera estructura condicional**: queremos que si existe algún menor de edad, nos imprima un mensaje indicándolo.

```{r}
if (any(edades < 18)) { # TRUE si al menos una persona mayor de edad
  
  print("existe alguna persona mayor de edad")
  
}
```

En caso de que no se cumplan las condiciones dentro del `if()` (condiciones que devuelvan un `FALSE`), no sucederá nada.

```{r}
if (all(edades >= 18)) { # TRUE si TODOS son mayores de edad
  
  print("todas las personas son mayores de edad")
  
}
```

Fíjate que en este caso no hemos obtenido ningún mensaje porque la condición `all(edades >= 18)` no es cierta (no son todos mayores de 18 años).

## if - else {}

La estructura `if (condicion) { }` puede ser combinada con un `else { }`, de forma que cuando la condición no se cumpla (como en el último ejemplo), se ejecutará el código que haya dentro del `else { }`, permitiéndonos decidir que sucede cuando SÍ se cumple y cuando NO se cumple

```{r}
if (all(edades >= 18)) { # TRUE si TODOS son mayores de edad
  
  print("todas las personas son mayores de edad")
  
} else { # si hay alguno menor de edad 
  
  print("existe alguna persona menor de edad")
}
```

Podemos ya complicar un poco el código con lo que hemos aprendido de temas anteriores: en caso de que haya alguno menor de edad, queremos extraer la edad por pantalla (con `edades[edades < 18]` extraeremos las edades que cumplen la condición de ser menor de edad).

```{r}
if (all(edades >= 18)) { # TRUE si TODOS son mayores de edad
  
  print("todas las personas son mayores de edad")
  
} else { # si hay alguno menor de edad 
  
  print(glue("Existe alguna persona menor de edad. Sus edades son: {edades[edades < 18]}"))
}
```

## if - else anidados

Dicha estructura `if - else` puede <mark>**anidarse**</mark>, de forma que vayamos concatenando dichas estructuras, como en el ejemplo que tenemos debajo. Imagina que queremos realizar una acción si todos fuesen mayores de edad; en caso contrario, pero si todos los menores de edad tienen 16 años o más, realizar otra acción; en caso contrario, otra acción

```{r}
if (all(edades >= 18)) { # TRUE si TODOS son mayores de edad
  
  print("todas las personas son mayores de edad")
  
} else if (all(edades >= 16)) { # si todos los menores de edad tienen >=16
  
  print("Existe alguna persona menor de edad pero todos con 16 años o más")
  
} else {
  
  print("Existe alguna persona menor de 16 años")

}
```

# ifelse () vectorizado

Esta <mark>**estructura condicional puede ser vectorizada**</mark>, de forma que podamos reunir en una **sola fila un número elevado de estructuras de comparación** la función `ifelse()`, cuyos argumentos de entrada serán la condición a evaluar, lo que sucede cuando se cumple y lo que no, que aplicará a cada elemento del vector de entrada. Con el ejemplo de las edades, vamos a **dejar el dato ausente si son menores de edad**, y si son mayores de edad se queda como está.

```{r}
# NA si no cumple la condición, la edad si se cumple.
ifelse(edades >= 18, edades, NA)
```

Todas estas estructuras no solo sirven para datos numéricos. Vamos a definir un vector de nombres con algunos ausentes (`NA`), y vamos a sustituir los ausentes por el texto `"nombre_desconocido"` (los que no sean ausentes se quedan como están).


```{r}
nombres <- c("Juan", "María", NA, NA, "Lucía", "Carmen", "Javier",
             NA, "Carlos", NA, "Gregorio", "Paloma")

# Si tiene ausente --> "nombre_desconocido"
# Si no tiene ausente --> nombres originales
nombres <- ifelse(is.na(nombres), "nombre_desconocido", nombres)
nombres
```

Esta función `ifelse()` es muy util para codificar variables o averiguar cuales cumplen una condición.

## Consejos


**`r colorize("CONSEJOS", "#20935E")`**

&nbsp;

**`r colorize("Rainbow parentheses", "#20935E")`**

Uno de los **errores más habituales**, y que seguirás cometiendo aunque lleves años programando, es <mark>**no cerrar un paréntesis que has abierto**</mark>, por lo que el programa no sabe si has acabado de llamar a una orden o no. Para ello en las nuevas versiones de `RStudio`, en el menú `Tools < Global Options < Code < Display` podemos habilitar la opción `Rainbow Parentheses` que nos escribe cada par de `()` de un color distinto

```{r echo = FALSE, out.width = "70%", fig.align = "center", fig.cap = "Activando Rainbow Parentheses."}
knitr::include_graphics("./img/rainbow-parentheses.jpg")

```

&nbsp;

**`r colorize("Minimiza estructuras de control en el código", "#20935E")`**

Puedes colapsar las estructuras de control pulsando en la flecha que aparece a la izquierda de ellas en tu script.

&nbsp;



## 📝 Ejercicios

(haz click en las flechas para ver soluciones)

<details>
  <summary>📝<strong>Ejercicio 1</strong>: modifica el código inferior para imprimir un mensaje por pantalla si todos los mamíferos del conjunto `MASS::mammals` pesan menos de una tonelada (variable `body`).
  
```{r}
peso <- MASS::mammals$body

if (peso[1] == 1000) {
  
  print("Todos los mamíferos guardados pesan menos de una tonelada")
  
}
  
```
</summary>
  
<!-- toc -->
- Solución:

```{r}
peso <- MASS::mammals$body

if (all(peso < 1000)) {
  
  print("Todos los mamíferos guardados pesan menos de una tonelada")
  
}

```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>📝<strong>Ejercicio 2</strong>: modifica el código inferior para imprimir un mensaje por pantalla si alguno de los mamíferos del conjunto `MASS::mammals` pesan menos de una tonelada (variable `body`).
  
```{r}
peso <- MASS::mammals$body

if (peso[1] == 1000) {
  
  print("Alguno de los mamíferos guardados pesan menos de una tonelada")
  
}
  
```
</summary>
  
<!-- toc -->
- Solución:

```{r}
peso <- MASS::mammals$body

if (any(peso < 1000)) {
  
  print("Alguno de los mamíferos guardados pesan menos de una tonelada")
  
}

```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>📝<strong>Ejercicio 3</strong>: modifica el código inferior para imprimir un mensaje por pantalla si el tercer mamífero del conjunto `MASS::mammals` tiene un cerebro que pesa más de 100 gr (variable `brain`).
  
```{r}
peso <- MASS::mammals$body

if (peso[1] == 1000) {
  
  print("El tercer mamífero tiene un cerebro que pesa más de 100 gr.")
  
}
  
```

</summary>
  
<!-- toc -->
- Solución:

```{r}
cerebro <- MASS::mammals$brain

if (cerebro[3] > 100) {
  
  print("El tercer mamífero tiene un cerebro que pesa más de 100 gr.")
  
}

```

No imprime nada porque no cumple la condición.


<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>📝<strong>Ejercicio 4</strong>: del paquete `{lubridate}`, la función `hour()` nos devuelve la hora de una fecha dada, y la función `now()` nos devuelve fecha y hora del momento actual. Con ambas funciones, y usando `if`, imprime por pantalla  `"buenas noches"` solo a partir de las 21 horas. </summary>
  
<!-- toc -->
- Solución:

```{r}
# Cargamos librería
library(lubridate)

# Fecha-hora actual
fecha_actual <- now()

# Estructura if
if (hour(fecha_actual) > 21) {
  
  cat("Buenas noches") # print/cat dos formas de imprimir por pantalla
}
```

<!-- tocstop -->
</details>

&nbsp;


<details>
  <summary>📝<strong>Ejercicio 5</strong>: con las funciones del ejercicio anterior, y usando una estructura `if-else`, imprime por pantalla `"buenos días"` (de 6 a 14 horas), `"buenas tardes"` (de 14 a 21 horas) o `"buenas noches"` (de las 21 a las 6 horas). </summary>
  
<!-- toc -->
- Solución:

```{r}
# Fecha actual
fecha_actual <- now()

# Estructura if-else
if (hour(fecha_actual) > 6 & hour(fecha_actual) < 14) {
  
  cat("Buenos días")
  
} else if (hour(fecha_actual) > 14 & hour(fecha_actual) < 21) {
  
  cat("Buenas tardes")
  
} else {
  
  cat("Buenas noches")
}
```

<!-- tocstop -->
</details>

&nbsp;


<details>
  <summary>📝<strong>Ejercicio 6</strong>: realiza el ejercicio anterior pero sin estructura de llaves, de forma concisa con `ifelse()`. Mira la ayuda si la necesitases poniendo `? ifelse`. </summary>
  
<!-- toc -->
- Solución:

```{r}
# Fecha actual
fecha_actual <- now()

# Estructura if-else
cat(ifelse(hour(fecha_actual) > 6 & hour(fecha_actual) < 14,
           "Buenos días",
           ifelse(hour(fecha_actual) > 14 &
                    hour(fecha_actual) < 21,
                  "Buenas tardes", "Buenas noches")))
  
```

<!-- tocstop -->
</details>

&nbsp;


